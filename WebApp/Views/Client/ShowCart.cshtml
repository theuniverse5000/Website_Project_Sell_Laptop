@{
    int stt = 0;
    string statuswallet = ViewContext.HttpContext.Session.GetString("StatusPointWallet");
    string username = ViewContext.HttpContext.Session.GetString("username");
}
<section class="h-100 h-custom">
    <div class="container h-100 py-5">
        <div class="row d-flex justify-content-center align-items-center h-100">
            <div class="col">

                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Số thứ tự</th>
                                <th scope="col">Mã sản phẩm</th>
                                <th scope="col">Số lượng</th>
                                <th scope="col">Giá</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var t in ViewBag.cartItem)
                            {
                                stt++;
                            
                            <tr>
                                <th>@stt</th>
                                <th>
                                    <div class="d-flex align-items-center">
                                        <div class="flex-column ms-4">
                                                <p class="mb-2">@t.MaProductDetail</p>
                                        </div>
                                    </div>
                                </th>
                                    <td class="align-middle">
                                        <div class="d-flex flex-row">
                                            <button class="btn btn-link px-2 decrease-quantity" data-id="@t.Id">
                                                <i class="fas fa-minus"></i>
                                            </button>
                                            <label id="quantity-cartdetail" class="form-control form-control-sm quantity-input" style="width: 50px;" data-id="@t.Id">@t.Quantity</label>
                                            <button class="btn btn-link px-2 increase-quantity" data-id="@t.Id">
                                                <i class="fas fa-plus"></i>
                                            </button>
                                        </div>
                                    </td>
                                <td class="align-middle">
                                        <p class="mb-0" style="font-weight: 500;">@t.Price*@t.Quantity</p>
                                </td>
                            </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="card shadow-2-strong mb-5 mb-lg-0" style="border-radius: 16px;">
                    <div class="card-body p-4">

                        <div class="row">
                            <div class="col-md-6 col-lg-4 col-xl-3 mb-4 mb-md-0">
                                <form>
                                    <div class="d-flex flex-row pb-3">
                                        <div class="d-flex align-items-center pe-2">
                                            <input class="form-check-input" type="radio" name="radioNoLabel" id="radioNoLabel1v"
                                                   value="" aria-label="..." checked />
                                        </div>
                                        <div class="rounded border w-100 p-3">
                                            <p class="d-flex align-items-center mb-0">
                                                <i class="fab fa-cc-mastercard fa-2x text-dark pe-2"></i>Credit
                                                Card
                                            </p>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-row pb-3">
                                        <div class="d-flex align-items-center pe-2">
                                            <input class="form-check-input" type="radio" name="radioNoLabel" id="radioNoLabel2v"
                                                   value="" aria-label="..." />
                                        </div>
                                        <div class="rounded border w-100 p-3">
                                            <p class="d-flex align-items-center mb-0">
                                                <i class="fab fa-cc-visa fa-2x fa-lg text-dark pe-2"></i>Debit Card
                                            </p>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-row">
                                        <div class="d-flex align-items-center pe-2">
                                            <input class="form-check-input" type="radio" name="radioNoLabel" id="radioNoLabel3v"
                                                   value="" aria-label="..." />
                                        </div>
                                        <div class="rounded border w-100 p-3">
                                            <p class="d-flex align-items-center mb-0">
                                                <i class="fab fa-cc-paypal fa-2x fa-lg text-dark pe-2"></i>VN PAY
                                            </p>
                                        </div>
                                    </div>
                                    <div class="d-flex flex-row">
                                        <div class="d-flex align-items-center pe-2">
                                            <input class="form-check-input" type="radio" name="radioNoLabel" id="radioNoLabel3v"
                                                   value="" aria-label="..." />
                                        </div>
                                        <div class="rounded border w-100 p-3">
                                            <p class="d-flex align-items-center mb-0">
                                                <i class="fab fa-cc-paypal fa-2x fa-lg text-dark pe-2"></i>Thanh toán bằng tiền mặt
                                            </p>
                                        </div>
                                    </div>
                                </form>
                            </div>
                           
                            <div class="container">
                                <h1>Chọn danh sách tỉnh</h1>
                                <form action="">
                                    <select name="" id="province">
                                    </select>
                                    <select name="" id="district">
                                        <option value="">chọn quận</option>
                                    </select>
                                    <select name="" id="ward">
                                        <option value="">chọn phường</option>
                                    </select>
                                </form>


                                <h2 id="result"></h2>
                            </div>
                            <div class="col-lg-4 col-xl-3">
                                <div class="d-flex justify-content-between" style="font-weight: 500;">
                                    <p class="mb-2">Thành tiền</p>
                                    <p class="mb-2">15.0000.000</p>
                                </div>

                                <div class="d-flex justify-content-between" style="font-weight: 500;">
                                    <p class="mb-0">Phí ship</p>
                                    <p class="mb-0">50.000</p>
                                </div>
                                <form asp-controller="Client" asp-action="CreateBill">
                                <div class="form-outline mb-4">
                                    <label class="form-label" for="voucherSelect">Chọn mã giảm giá</label>
                                        <select id="voucherSelect" name="codeVoucher" class="form-select form-select-lg">
                                        <option value="null">Không có</option>
                                        @foreach (var i in ViewBag.listVoucher)
                                        {
                                                <option value="@i.MaVoucher">@i.MaVoucher</option>
                                            }
                                    </select>

                                       
                                        @{
                                            if (statuswallet == "2")
                                            {

                                                <label>Ví điểm của @username </label>
                                                <div id=" id=" sodiemhiencolb"" style="color: blue;">Số điểm hiện có:  <label class="form-label" id="sodiemhiencolb"></label></div>
                                                <label class="form-label" for="sudungdiem">Sử dụng điểm: </label>
                                                <input type="number" id="diemInput" name="PointYouWanToUse"/>
                                                <div id="error-message" style="color: red;"></div>

                                               
                                            }

                                       }
                                </div>
                                <hr class="my-4">

                                <div class="d-flex justify-content-between mb-4" style="font-weight: 500;">
                                    <p class="mb-2">Thành tiền</p>
                                    <p class="mb-2" id="totalAmount">15.000.000</p>
                                </div>

                                    <a asp-controller="Vnpay" asp-action="Index" class="btn btn-primary btn-block btn-lg">
                                        <div class="d-flex justify-content-between">
                                            <span>Thanh toán</span>
                                            <span>15.000.000</span>
                                        </div>
                                    </a>
                                <button  class="btn btn-primary btn-block btn-lg" type="submit">
                                    <div class="d-flex justify-content-between">
                                        <span>Đặt hàng</span>
                                        <span>15.000.000</span>
                                    </div>
                                    </button>
                                </form>

                            </div>
                        </div>

                    </div>
                </div>

            </div>
        </div>
    </div>
</section>
<script>
    // function applySelectedVoucher() {
    //     // Lấy giá trị mã voucher từ option được chọn
    //     var selectedVoucher = document.getElementById('voucherSelect').value;

    //     // Gửi yêu cầu đến API để lấy giá trị giảm giá cho mã voucher được chọn
    //     $.ajax({
    //         url: 'https://your-api-url/voucher',
    //         type: 'GET',
    //         data: { voucherCode: selectedVoucher },
    //         success: function (response) {
    //             // Xử lý phản hồi từ API
    //             if (response.success) {
    //                 // Giảm giá thành công
    //                 var discount = response.discount;
    //                 updateTotalWithDiscount(discount);
    //             } else {
    //                 // Hiển thị thông báo lỗi nếu cần
    //                 alert('Invalid voucher code');
    //             }
    //         },
    //         error: function () {
    //             // Xử lý lỗi nếu có
    //             alert('Error applying voucher');
    //         }
    //     });
    // }

    // function updateTotalWithDiscount(discount) {
    //     // Tính toán giá mới sau khi áp dụng voucher
    //     var originalTotal = 26.48; // Giả sử giá trước khi giảm giá là 26.48
    //     var discountedTotal = originalTotal - (originalTotal * discount);

    //     // Cập nhật giá trên giao diện người dùng
    //     document.getElementById('totalAmount').innerText = '$' + discountedTotal.toFixed(2);
    // }
    $(document).ready(function () {
        $(".decrease-quantity").click(function () {
            var itemId = $(this).data("id");
            var row = $(this).closest('tr');
            var quantityLabel = row.find(".quantity-input");
          
            $.ajax({
                url: '/Client/DecreaseQuantity',
                type: 'POST',
                data: { idCartDetail: itemId },
                success: function (response) {
                    var currentQuantity = parseInt(quantityLabel.text());
                    var newQuantity = currentQuantity - 1;
                    quantityLabel.text(newQuantity);
                },
                error: function (error) {
                    console.error('Error:', error);
                }
            });
        });
        $(".increase-quantity").click(function () {
            var itemId = $(this).data("id");
            var row = $(this).closest('tr');
            var quantityLabel = row.find(".quantity-input");

            $.ajax({
                url: '/Client/IncreaseQuantity',
                type: 'POST',
                data: { idCartDetail: itemId },
                success: function (response) {
                    var currentQuantity = parseInt(quantityLabel.text());
                    var newQuantity = currentQuantity + 1;
                    quantityLabel.text(newQuantity);
                },
                error: function (error) {
                    console.error('Error:', error);
                }
            });
        });
    });

    </script>






<script>

    // function calculateTotalAmount() {
    //     var totalAmount = 0;

    //     // Iterate through each row in the table
    //     $("#yourTableId tbody tr").each(function () {
    //         var quantity = parseInt($(this).find(".quantity-input").text());
    //         var price = parseFloat($(this).find("td:eq(2) p").text().replace(',', '')); // Adjust the index based on your actual structure

    //         totalAmount += quantity * price;
    //     });
    //     console.log(totalAmount);
    //     alert(totalAmount);
    //     return totalAmount;
    // }



    // function updateTotalAmount() {
    //     var totalAmount = 0;

    //     // Loop through each row in the table
    //     $("tbody tr").each(function () {
    //         var quantity = parseInt($(this).find(".quantity-input").text());
    //         var price = parseFloat($(this).find(".price").text().replace(',', '')); // Assuming the price is displayed as a string with commas

    //         totalAmount += quantity * price;
    //     });

    //     // Update the total amount on the UI
    //     $("#totalAmount").text(formatCurrency(totalAmount)); // Format the total amount as needed
    // }

    // // Function to format currency
    // function formatCurrency(amount) {
    //     // Customize this function based on your currency formatting requirements
    //     var formatter = new Intl.NumberFormat('en-US', {
    //         style: 'currency',
    //         currency: 'USD', // Change this to your currency code
    //         minimumFractionDigits: 2
    //     });

    //     return formatter.format(amount);
    // }

    // $("#diemInput").on("input", function () {
    //     var soDiemMuonDoi = parseFloat($(this).val());
    //     var tongTienHoaDon = calculateTotalAmount(); // Calculate the total amount based on product prices and quantities

    //     $.ajax({
    //         type: "POST",
    //         url: "https://localhost:44333/api/ChucNangTichDiem/CalculateTotalAmount",
    //         data: {
    //             tongTienHoaDon: tongTienHoaDon,
    //             soDiemMuonDoi: soDiemMuonDoi
    //         },
    //         success: function (response) {
    //             $(

    //                 "#totalAmount").text(formatCurrency(response.totalAmount));
    //         },
    //         error: function (error) {
    //             console.error('Error:', error);
    //         }
    //     });
    // });





    // Biến để chứa số điểm hiện có từ ví điểm
    var soDiemHienCo;

    // Hàm để lấy số điểm hiện có từ backend
    async function fetchSoDiemHienCo() {
        try {
            var name = "@(username)";

            const response = await fetch('https://localhost:44333/api/ChucNangTichDiem/GetThePointOfWallet?usename=' + name);
            const data = await response.json();

            // Cập nhật giá trị của soDiemHienCo từ dữ liệu nhận được từ backend
            soDiemHienCo = data.soDiemHienCo;
            console.log(soDiemHienCo);
            console.log(response);
            // Gọi hàm validateInput để kiểm tra giá trị nhập vào
            validateInput();
            document.getElementById("sodiemhiencolb").innerText = soDiemHienCo.toString();

        } catch (error) {
            console.error('Error fetching soDiemHienCo:', error);
        }
    }

    // Gọi hàm fetchSoDiemHienCo khi trang được tải để lấy số điểm hiện có từ backend
    window.addEventListener('load', fetchSoDiemHienCo);

    function validateInput() {
        // Lấy giá trị từ input
        var diemInputValue = document.getElementById("diemInput").value.trim();

        // Nếu người dùng không nhập, không thực hiện kiểm tra
        if (diemInputValue === "") {
            document.getElementById("error-message").innerText = "";
            return;
        }

        // Kiểm tra giá trị nhập vào
        var diemInputNumber = parseInt(diemInputValue);
        if (isNaN(diemInputNumber) || diemInputNumber < 0) {
            document.getElementById("error-message").innerText = "Giá trị không hợp lệ. Vui lòng nhập một số không nhỏ hơn 0.";
        } else if (diemInputNumber > soDiemHienCo) {
            document.getElementById("error-message").innerText = "Không thể sử dụng số điểm vượt quá số điểm hiện có trong ví điểm.";
        } else {
            document.getElementById("error-message").innerText = "";
        }
    }

    // Gọi hàm validateInput mỗi khi giá trị trong input thay đổi
    document.getElementById("diemInput").addEventListener("input", validateInput);


</script>

